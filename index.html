<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帯屋町筋クイズ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="start-screen" class="screen active">
        <h1>帯屋町筋クイズに挑戦！</h1>
        
        <p>今日このクイズに参加した人数：<span id="counter-quiz">---</span>人</p>
        
        <p>ポスターのクイズを解き始めるには、下のボタンを押してください！</p>
        <button id="start-quiz-button">クイズを始める</button>
    </div>

    <div id="quiz-screen" class="screen">
        <h2 id="quiz-title"></h2>
        <p id="question-text"></p>
        
        <div id="audio-container" style="display: none; margin: 20px 0;">
            <audio id="quiz-audio" controls></audio>
        </div>

        <div id="options-container">
        </div>
    </div>

    <div id="result-screen" class="screen">
        <h2 id="result-message"></h2>
        <p>お疲れ様でした！</p>
        <button id="restart-button">参加人数画面に戻る</button>
    </div>

    <script src="quiz.js"></script>
    <script>
        // DOM要素の取得
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const startQuizButton = document.getElementById('start-quiz-button');
        const restartButton = document.getElementById('restart-button');
        
        // ★★★ 1. 設定必須：クイズIDの指定 ★★★
        // このファイルを quiz1 のQRコードで使う場合は 'quiz_1' に設定
        const TARGET_QUIZ_ID = 'quiz_1'; 
        
        // QUIZ_DATAから対象のクイズデータを取得（これが「選択されたクイズ」となる）
        const currentQuizData = QUIZ_DATA.find(q => q.id === TARGET_QUIZ_ID); 

        // 画面切り替え関数
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // --- GAS連携関数 ---
        
        // ★★★ 2. 設定必須：GASのウェブアプリのURLに書き換えてください ★★★
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzdT8j34I3GE8bFct4ZgfHDwjFpIqQflww0wLiR-DJXNIG6gN-KgY9ed2ReJ1PVnukB/exec"; 
        
        /**
         * 参加人数をスプレッドシートから読み込み、HTMLに表示する
         */
        function displayCounter() {
            const counterKey = TARGET_QUIZ_ID.replace('_', '') + '_count';
            const counterElement = document.getElementById('counter-quiz');
            if (!counterElement) return;
            
            fetch(`${GAS_API_URL}?quizId=${counterKey}&method=get`)
                .then(response => response.json())
                .then(data => {
                    const count = data[counterKey];
                    if (count !== undefined) {
                        counterElement.textContent = count;
                    } else {
                        counterElement.textContent = '取得エラー';
                    }
                })
                .catch(error => {
                    console.error("GAS読み込みエラー:", error);
                    counterElement.textContent = '通信エラー';
                });
        }

        /**
         * 参加人数を+1してスプレッドシートに書き込む
         */
        async function incrementCounter() {
            const counterKey = TARGET_QUIZ_ID.replace('_', '') + '_count';
            
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        quizId: counterKey,
                        method: 'post'
                    })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    // カウントアップ成功後、画面上の人数をすぐに更新
                    document.getElementById('counter-quiz').textContent = result.newCount; 
                } else {
                    console.error("GAS更新失敗:", result.message);
                }
            } catch (error) {
                console.error("GAS更新通信エラー:", error);
            }
        }
        // -----------------------------------------------------------------


        // クイズ開始
        function startQuiz() {
            if (!currentQuizData) {
                console.error("エラー: 対象のクイズデータが見つかりません。TARGET_QUIZ_IDを確認してください。");
                return;
            }

            // クイズ画面に遷移する直前に、カウンターを+1する
            incrementCounter();

            // クイズ画面の要素を更新
            document.getElementById('quiz-title').textContent = currentQuizData.title;
            document.getElementById('question-text').textContent = currentQuizData.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            // 音声問題の対応
            const audioContainer = document.getElementById('audio-container');
            const quizAudio = document.getElementById('quiz-audio');
            
            if (currentQuizData.type === 'audio' && currentQuizData.audio_src) {
                audioContainer.style.display = 'block';
                quizAudio.src = currentQuizData.audio_src;
                quizAudio.load();
            } else {
                audioContainer.style.display = 'none';
                quizAudio.src = '';
            }

            // 選択肢ボタンの生成
            currentQuizData.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(button);
            });

            showScreen('quiz-screen');
        }

        // 回答判定
        function checkAnswer(selectedOption) {
            // currentQuizDataを使用して正否を判定
            const isCorrect = (selectedOption === currentQuizData.answer);
            const messageElement = document.getElementById('result-message');
            
            // 音声を停止
            const quizAudio = document.getElementById('quiz-audio');
            quizAudio.pause();
            quizAudio.currentTime = 0;

            if (isCorrect) {
                messageElement.textContent = '🎉 正解です！帯屋町マニア！';
                messageElement.style.color = 'green';
            } else {
                // 不正解の場合は正解を表示
                messageElement.textContent = `残念！正解は「${currentQuizData.answer}」でした。`;
                messageElement.style.color = 'red';
            }

            // 最終結果画面に遷移
            showScreen('result-screen');
        }

        // リスタート（選択画面へ戻る）ボタンの設定
        restartButton.onclick = () => {
            showScreen('start-screen');
            displayCounter(); // 人数を再表示
        };

        // 初期化処理
        document.addEventListener('DOMContentLoaded', () => {
            // 初期画面ロード時に人数を読み込む
            displayCounter();
            
            // クイズを始めるボタンにイベントを設定
            startQuizButton.onclick = startQuiz;
        });
    </script>
</body>
</html>